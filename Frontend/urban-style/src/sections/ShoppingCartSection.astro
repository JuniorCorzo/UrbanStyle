---
import Button from "@/components/Button.astro";
import Counter from "@/components/home/Counter.astro";
import InfoRow from "@/components/InfoRow.astro";
import Subtitle from "@/components/text/Subtitle.astro";
import { CartStore } from "@/state/cart.state";
import { ProductStore } from "@/state/product.store";
import { TrashIcon } from "@heroicons/react/24/outline";

const userId = Astro.locals.user.id;
const { getCartByUserId, calculateTotal } = await CartStore(userId);
const { getProductById } = await ProductStore();

const items = getCartByUserId()?.items || [];
const total = calculateTotal();
---

<section id="cart-section" class="flex">
  <article class="flex flex-col gap-14 grow">
    {
      items.map(({ productId, name, price, quantity }) => (
        <div class="flex gap-5 px-20">
          <div>
            <img
              class="size-40 object-cover aspect-square"
              src={getProductById(productId).get()?.images[0]}
              alt={name}
            />
          </div>
          <div class="w-full flex justify-between">
            <div class="flex flex-col">
              <div class="flex grow flex-col gap-1">
                <Subtitle size="xl" Text={name} />
                <span>
                  Color: <strong>Rojo</strong>
                </span>
                <span>
                  Talla: <strong>S</strong>
                </span>
              </div>
              <div class="basis-5">
                <Button
                  id="remove-product"
                  class="flex bg-transparent border-0 items-center gap-2 hover:ring-0 hover:scale-105"
                  size="custom"
                  data-product-id={productId}
                  data-user-id={userId}
                >
                  <TrashIcon className="size-6 stroke-maroon pointer-events-none" />
                  <span class="text-maroon font-semibold pointer-events-none">
                    Remover
                  </span>
                </Button>
              </div>
            </div>
            <div class="flex flex-col gap-1 items-end">
              <Counter
                id="quantity_input"
                maxNumber={getProductById(productId).get()?.stock || 0}
                value={quantity.toString()}
                data-user-id={userId}
                data-product-id={productId}
              />
              <Subtitle id="price_unit" size="lg" Text={`$${price}/u`} />
              <Subtitle
                id="product_total"
                size="lg"
                Text={`$${(price * quantity).toFixed(2)}`}
              />
            </div>
          </div>
        </div>
      ))
    }
  </article>
  <article class="flex flex-col basis-96 gap-1 mt-5 pr-7">
    <Subtitle size="xl" Text="Detalles" />
    <div class="flex flex-col border-border gap-11 pt-5">
      <div class="flex flex-col gap-1">
        <InfoRow label="Total" value={`<strong>${total}</strong>`} />
        <InfoRow label="EnviÃ³" value="<strong>Gratis</strong>" />
        <InfoRow
          class="pt-5"
          label="Total con Iva"
          value={`<strong id="total">${(total + total * 0.19).toFixed(2)}</strong>`}
        />
      </div>
      <Button> Realizar el pedido por WhatsApp </Button>
    </div>
  </article>
</section>

<script>
  import { $, $$ } from "@/lib/dom-selector";
  import { CartService } from "@/service/cart.service";
  import { updateCartState } from "@/service/updateCartState";
  import { navigate } from "astro:transitions/client";

  const debounceTimers: Record<string, ReturnType<typeof setTimeout>> = {};

  const handleRemoveItem = ($target: HTMLElement) => {
    const { userId, productId } = $target.dataset;
    if (!userId || !productId) return;

    CartService()
      .removeProductFromCart(userId, productId)
      .then((response) => {
        updateCartState(response)
          .then((response) => {
            if (response.status === 204) {
              location.reload();
            }
          })
          .catch(console.error);
      });
  };

  const handleChangeQuantity = ($target: HTMLElement) => {
    const { userId, productId } = ($target.parentElement as HTMLDivElement)
      ?.dataset;

    const $input = $target.parentElement?.querySelector(
      "#quantity_input"
    ) as HTMLInputElement;

    if (!userId || !productId || $input.dataset.value === $input.value) return;

    if (debounceTimers[productId]) {
      clearTimeout(debounceTimers[productId]);
    }

    debounceTimers[productId] = setTimeout(() => {
      CartService()
        .updateQuantityProductInCart(userId, productId, $input.valueAsNumber)
        .then((cart) => {
          updateCartState(cart).then(() =>
            navigate(location.pathname, { history: "replace" })
          );
          $input.setAttribute("data-value", cart.items[0].quantity.toString());
        });
    }, 300);
  };

  const handleClick = (event: MouseEvent) => {
    const $target = event.target as HTMLElement;
    if ($target.id === "remove-product") {
      handleRemoveItem($target);
      return;
    }

    if ($target.id === "increment" || $target.id === "decrement") {
      handleChangeQuantity($target);
      return;
    }
  };

  const initCounterListeners = () => {
    $$<HTMLDivElement>("#quantity_input").forEach(($input) => {
      // Evita duplicar listeners
      $input.onblur = null;
      $input.addEventListener("blur", () => {
        handleChangeQuantity($input);
      });
    });

    $("#cart-section")?.addEventListener("click", handleClick);
  };

  document.addEventListener("astro:page-load", () => {
    initCounterListeners();
  });

  document.addEventListener("astro:after-swap", () => {
    initCounterListeners();
  });
</script>
